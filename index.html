<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kinetic Cosmos</title>
    <meta name="description" content="Experience a fully immersive 3D generative art animation with randomized shapes, colors, motion styles, and a dynamic starfield, all generated by in-page JavaScript.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="canonical" href="https://pirillo.com/arcade/kineticcosmos.html">
    <meta property="og:title" content="Kinetic Cosmos">
    <meta property="og:description" content="Explore an ever-changing 3D universe of interactive shapes with JavaScript-generated colors, forms, and movements, plus a mesmerizing starfield.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pirillo.com/arcade/kineticcosmos.html">
    <meta property="og:image" content="https://pirillo.com/arcade/images/kineticcosmos.png">
    <meta property="og:image:alt" content="A preview of the Dynamic Shape Matrix animation with JavaScript-driven randomization.">
    <meta property="og:site_name" content="Chris Pirillo's Arcade">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@ChrisPirillo">
    <meta name="twitter:title" content="Kinetic Cosmos">
    <meta name="twitter:description" content="A captivating, fully immersive 3D animation with randomized shapes, colors, themes, and motion, powered by p5.js and in-page JavaScript.">
    <meta name="twitter:image" content="https://pirillo.com/arcade/images/kineticcosmos.png">
    <meta name="twitter:image:alt" content="A preview of the Dynamic Shape Matrix animation with JavaScript-driven randomization.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap"></noscript>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js" as="script">
    <link rel="icon" href="https://placehold.co/32x32/483D8B/FFFFFF?text=CPX" type="image/png">
    <style>
        /* CSS Reset & Base Styles */
        :root {
            --ui-primary-bg: rgba(106, 90, 205, 0.15); /* More subtle button bg */
            --ui-primary-text: #C8BFE7; /* Lighter text for buttons */
            --ui-primary-border: #5A4DAD; /* Slightly softer border */
            --ui-primary-hover-bg: #6A5ACD;
            --ui-primary-hover-text: #FFFFFF;

            --ui-accent-text: #B0A4E3; /* For labels and less prominent text */
            --ui-slider-track-bg: rgba(72, 61, 139, 0.3);
            --ui-slider-thumb-bg: #7B68EE; /* MediumSlateBlue for thumb */
            --ui-panel-bg: rgba(20, 20, 35, 0.95); /* Darker, slightly more purple panel */
            --ui-panel-border: rgba(72, 61, 139, 0.6);
            --ui-value-display-text: #D8CCE0;
            --ui-label-text: #B0A4E3; /* Added for consistency */
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-size: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            line-height: 1.4;
            color: #E0E0E0;
            background-color: #030307;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .controls-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 0.5rem; /* Compact padding */
            background-color: var(--ui-panel-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            border-top: 1.5px solid var(--ui-panel-border);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            max-height: 35vh; /* Significantly reduced max-height */
            overflow-y: auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .controls-overlay.hidden {
            transform: translateY(100%);
            pointer-events: none;
        }

        .controls-toggle-button {
            position: fixed;
            bottom: 0.75rem; /* Adjusted position */
            right: 0.75rem;
            background-color: var(--ui-primary-border);
            color: var(--ui-primary-hover-text);
            border: none;
            border-radius: 50%;
            width: 44px; /* Smaller toggle button */
            height: 44px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            padding:0;
            box-shadow: 0 2px 8px rgba(0,0,0, 0.35);
            transition: background-color 0.2s, transform 0.2s ease-out;
        }
         .controls-toggle-button svg {
            width: 20px; /* Adjusted icon size */
            height: 20px;
            fill: var(--ui-primary-hover-text);
            transition: transform 0.2s ease-out;
        }
        .controls-toggle-button:hover {
            background-color: var(--ui-primary-hover-bg);
            transform: scale(1.08);
        }
        .controls-toggle-button.panel-open svg { /* Simplified selector for rotation */
             transform: rotate(90deg);
        }

        .controls-main-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Reduced gap */
            width: 100%;
            max-width: 700px; /* More compact max width */
        }

        .controls-sliders-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Responsive grid */
            gap: 0.5rem;
            align-items: start;
            padding: 0 0.25rem; /* Add slight horizontal padding */
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.25rem;
            background-color: transparent; /* No background for individual groups */
            border-radius: 4px;
        }

        .slider-label-value-group { /* Group label and value */
            display: flex;
            justify-content: space-between; /* Label left, value right */
            align-items: baseline;
            width: 100%;
            max-width: 120px; /* Match slider width */
            margin-bottom: 0.1rem;
        }
        .slider-label {
            font-size: 0.65rem; /* Increased font size */
            color: var(--ui-label-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 400;
        }
        .slider-value-display {
            font-size: 0.65rem; /* Increased font size */
            color: var(--ui-value-display-text);
            font-weight: 500;
        }

        .controls-overlay input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            max-width: 120px;
            height: 4px; /* Very thin track */
            background: var(--ui-slider-track-bg);
            border-radius: 2px;
            cursor: pointer;
            outline: none;
            margin-top: 0.1rem;
        }

        .controls-overlay input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--ui-slider-thumb-bg);
            border-radius: 50%;
            border: 1px solid var(--ui-panel-bg);
            box-shadow: 0 0 3px var(--ui-slider-thumb-bg);
        }
        .controls-overlay input[type="range"]::-moz-range-track {
            width: 100%; height: 4px; background: var(--ui-slider-track-bg); border-radius: 2px; cursor: pointer;
        }
        .controls-overlay input[type="range"]::-moz-range-thumb {
            width: 12px; height: 12px; background: var(--ui-slider-thumb-bg); border-radius: 50%; border: 1px solid var(--ui-panel-bg); box-shadow: 0 0 3px var(--ui-slider-thumb-bg); cursor: pointer;
        }

        .controls-buttons-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.4rem;
            width: 100%;
            margin-top: 0.25rem;
        }

        .controls-overlay button {
            font-family: 'Orbitron', sans-serif;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            border: 1px solid var(--ui-primary-border);
            background-color: var(--ui-primary-bg);
            color: var(--ui-primary-text);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-weight: 500;
            font-size: 0.7rem; /* Increased font size */
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex-grow: 0;
            flex-shrink: 0;
        }
         button#resetDefaults {
            min-width: auto;
            padding: 0.3rem 0.7rem;
        }

        .controls-overlay button:hover {
            background-color: var(--ui-primary-hover-bg);
            color: var(--ui-primary-hover-text);
            box-shadow: 0 1px 4px rgba(0,0,0, 0.2);
        }
        .controls-overlay button:active {
            transform: scale(0.97);
        }
        .controls-overlay button:disabled { /* Kept for potential future use, though not for API loading now */
            border-color: #222;
            color: #555;
            cursor: not-allowed;
            background-color: rgba(0,0,0,0.1);
            box-shadow: none;
        }

        /* Site Menu Trigger (Top Right) */
        .site-menu-trigger {
            position: fixed;
            top: 0.5rem; /* Closer to top */
            right: 0.5rem; /* Closer to right */
            font-size: 0.75rem;
            color: var(--ui-accent-text);
            cursor: pointer;
            z-index: 101;
            text-decoration: none;
            font-weight: 500;
            padding: 0.25rem 0.4rem;
            background-color: rgba(10, 10, 20, 0.6);
            border-radius: 3px;
            border: 1px solid var(--ui-panel-border);
            transition: color 0.3s, background-color 0.3s;
        }
        .site-menu-trigger:hover {
            color: var(--ui-primary-hover-text);
            background-color: var(--ui-primary-hover-bg);
        }

        .site-nav-menu {
            position: fixed;
            top: calc(0.5rem + 28px + 0.2rem); /* Adjusted for trigger */
            right: 0.5rem;
            background-color: var(--ui-panel-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--ui-panel-border);
            border-radius: 6px; padding: 0.4rem;
            z-index: 100;
            display: none; flex-direction: column; gap: 0.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.35);
            min-width: 150px;
        }
        .site-nav-menu.visible { display: flex; }
        .site-nav-menu a {
            color: var(--ui-primary-text); text-decoration: none; font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.4rem; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;
        }
        .site-nav-menu a:hover { background-color: var(--ui-primary-hover-bg); color: var(--ui-primary-hover-text); }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .controls-overlay {
                max-height: 50vh;
                padding: 0.3rem;
            }
            .controls-sliders-wrapper {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Even more compact grid */
                gap: 0.3rem;
            }
            .controls-buttons-group {
                flex-direction: column;
                align-items: stretch;
                gap: 0.2rem;
            }
            .controls-buttons-group button {
                width: 100%;
            }
            .control-group {
                padding: 0.1rem;
            }
            .slider-label, .slider-value-display { font-size: 0.6rem; } /* Adjusted for mobile */
            .controls-overlay button { font-size: 0.65rem; padding: 0.25rem 0.4rem;} /* Adjusted for mobile */
        }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "Dynamic Shape Matrix (JS Randomized) | Chris Pirillo's Arcade",
      "description": "Experience a fully immersive 3D generative art animation with randomized shapes, colors, motion styles, and a dynamic starfield, all generated by in-page JavaScript.",
      "url": "https://pirillo.com/arcade/",
      "publisher": { "@type": "Organization", "name": "Chris Pirillo", "logo": { "@type": "ImageObject", "url": "https://placehold.co/200x60/483D8B/FFFFFF?text=CP+Logo"}},
      "mainEntity": {
        "@type": "CreativeWork",
        "name": "Dynamic Shape Matrix with JavaScript Randomization",
        "description": "An ever-changing, fully immersive 3D animation of randomized shapes reacting to mouse movements, with colors, shape themes, and motion styles generated by in-page JavaScript, plus a dynamic starfield. Created with p5.js.",
        "author": { "@type": "Person", "name": "Chris Pirillo" },
        "genre": "Generative Art, Interactive Art, Immersive Experience",
        "isAccessibleForFree": true,
        "image": "https://placehold.co/1200x630/483D8B/FFFFFF?text=JS+Universe+Preview"
      },
      "breadcrumb": {"@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Arcade", "item": "https://pirillo.com/arcade/"}]}
    }
    </script>
    </head>
<body>
    <a href="#main-content-anchor" class="sr-only sr-only-focusable">Skip to controls</a>
    <div id="main-content-anchor" tabindex="-1"></div>
    <div id="canvas-container" aria-label="Immersive interactive 3D shape animation. Mouse interaction changes shape positions. Colors, shape types, and motion styles can be changed via randomize buttons in the controls.">
    </div>
    <div id="status-message" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background-color:var(--ui-panel-bg); color:var(--ui-primary-text); padding:20px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.4); text-align:center; max-width:300px;">
            <p id="customModalMessage" style="margin-bottom:15px; font-size:0.9rem; line-height:1.5;"></p>
            <button id="customModalClose" style="font-family: 'Orbitron', sans-serif; padding: 0.4rem 0.8rem; border-radius: 4px; border: 1px solid var(--ui-primary-border); background-color: var(--ui-primary-bg); color: var(--ui-primary-text); cursor: pointer;">OK</button>
        </div>
    </div>


    <button id="controlsToggleButton" class="controls-toggle-button" aria-label="Toggle Controls Panel" aria-expanded="false">
        </button>
    <div id="controlsOverlay" class="controls-overlay hidden" role="toolbar" aria-labelledby="controls-heading">
        <h2 id="controls-heading" class="sr-only">Animation Controls</h2>

        <div class="controls-main-wrapper">
            <div class="controls-sliders-wrapper">
                <div class="control-group">
                    <div class="slider-label-value-group">
                        <span class="slider-label">Shapes</span>
                        <span class="slider-value-display" id="shapeCountValue">1000</span>
                    </div>
                    <input type="range" id="shapeCount" name="shapeCount" min="50" max="2000" value="1000" step="50" aria-describedby="shapeCountValue">
                </div>
                <div class="control-group">
                    <div class="slider-label-value-group">
                        <span class="slider-label">Approach</span>
                        <span class="slider-value-display" id="approachDistanceValue">1</span>
                    </div>
                    <input type="range" id="approachDistance" name="approachDistance" min="-500" max="500" value="1" step="10" aria-describedby="approachDistanceValue">
                </div>
                <div class="control-group">
                     <div class="slider-label-value-group">
                        <span class="slider-label">Min Weight</span>
                        <span class="slider-value-display" id="minLineWeightValue">0.020</span>
                    </div>
                    <input type="range" id="minLineWeight" name="minLineWeight" min="0.005" max="0.1" value="0.02" step="0.001" aria-describedby="minLineWeightValue">
                </div>
                <div class="control-group">
                    <div class="slider-label-value-group">
                        <span class="slider-label">Max Weight</span>
                        <span class="slider-value-display" id="maxLineWeightValue">0.100</span>
                    </div>
                    <input type="range" id="maxLineWeight" name="maxLineWeight" min="0.02" max="0.3" value="0.1" step="0.005" aria-describedby="maxLineWeightValue">
                </div>
            </div>

            <div class="controls-buttons-group">
                <button id="randomizeColorButton">Randomize Colors</button>
                <button id="randomizeShapeButton">Randomize Shapes</button>
                <button id="randomizeMotionButton">Randomize Motion</button>
                <button id="resetDefaults">Defaults</button>
            </div>
        </div>
    </div>

    <a href="#" id="siteMenuTrigger" class="site-menu-trigger" aria-haspopup="true" aria-expanded="false">@ChrisPirillo</a>
    <nav id="siteNavMenu" class="site-nav-menu" aria-label="Chris Pirillo Links">
        <a href="https://chrispirillo.bio.link/" target="_blank" rel="noopener noreferrer">Follow Chris</a>
        <a href="https://www.chrispirillo.com/" target="_blank" rel="noopener noreferrer">Meet Chris</a>
        <a href="https://chrispirillo.substack.com/" target="_blank" rel="noopener noreferrer">Read Chris</a>
        <a href="/arcade/">Play with Chris</a>
        <a href="https://www.linkedin.com/in/chrispirillo/" target="_blank" rel="noopener noreferrer">Connect with Chris</a>
        <a href="https://discord.com/invite/XRBTM8sAMX" target="_blank" rel="noopener noreferrer">Chat with Chris</a>
    </nav>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script>
    // --- P5.js Sketch Logic & Global Variables ---
    let shapes = [];
    let numShapes = 1000;
    const SHAPE_TYPES = ['box', 'sphere', 'torus', 'cone']; // Keep available shape types
    let shapeProbabilities = [0.25, 0.25, 0.25, 0.25]; // Default probabilities

    let starfieldParticles = [];
    const NUM_STARS = 700;
    let starDriftX = 0;
    let starDriftY = 0;

    let minWeight = 0.02;
    let maxWeight = 0.1;
    let approachDistance = 1;

    // Motion parameters
    let baseRotSpeedRange = [-0.02, 0.02];
    let zAmplitude = 500;
    let zFrequency = 0.15;
    let mouseForceMultiplier = 1.0;
    let springinessFactor = 0.03;

    // Color parameters
    let currentBgColor = [5, 5, 10]; // Dark blue/purple
    let currentStrokeColor = [72, 61, 139, 180]; // SlateBlue with alpha
    let currentAccentColor = [200, 200, 255]; // Light lavender for stars

    // Standard, simple SVGs for UI icons
    const gearIconSVG = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.06-0.7-1.62-0.94L14.4,2.23C14.38,2.01,14.19,1.85,13.96,1.85 h-3.92c-0.23,0-0.42,0.15-0.44,0.38L9.22,4.88c-0.56,0.24-1.12,0.55-1.62,0.94L5.21,4.86c-0.22-0.08-0.47,0-0.59,0.22L2.7,8.41 c-0.12,0.21-0.07,0.47,0.12,0.61l2.03,1.58c-0.05,0.3-0.07,0.62-0.07,0.94s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.06,0.7,1.62,0.94l0.38,2.65 c0.03,0.23,0.21,0.38,0.44,0.38h3.92c0.23,0,0.42-0.15,0.44-0.38l0.38-2.65c0.56-0.24,1.12-0.55,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.21,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.61-3.6-3.6 s1.61-3.6,3.6-3.6s3.6,1.61,3.6,3.6S13.98,15.6,12,15.6z" fill="currentColor"/></svg>`;
    const closeIconSVG = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/></svg>`;

    // --- P5.js Setup Function ---
    function setup() {
        const canvasContainer = document.getElementById('canvas-container');
        let cnv = createCanvas(windowWidth, windowHeight, WEBGL);
        cnv.parent('canvas-container');
        noFill(); // Default for shapes
        initializeShapes(); // Create initial shapes
        initializeStarfield(); // Create starfield
        updateUICssVariables(); // Apply initial colors to UI
        const statusMessage = document.getElementById('status-message');
        if (statusMessage) statusMessage.textContent = "Dynamic shape animation loaded.";
        initializePageControls(); // Setup sliders and buttons
    }

    // --- P5.js Draw Loop ---
    function draw() {
        background(currentBgColor[0], currentBgColor[1], currentBgColor[2]); // Set background
        starDriftX += 0.05; // Slow horizontal drift for stars
        starDriftY += 0.02; // Slow vertical drift for stars
        drawStarfield(); // Render starfield

        // Dynamic stroke weight based on noise
        let weight = map(noise(frameCount * 0.0015), 0, 1, minWeight, maxWeight);
        strokeWeight(weight);
        stroke(currentStrokeColor[0], currentStrokeColor[1], currentStrokeColor[2], currentStrokeColor[3] || 255); // Set stroke color
        noFill(); // Ensure shapes are outlines

        // Map mouse position for interaction
        let mx = map(mouseX, 0, width, -width/1.5, width/1.5);
        let my = map(mouseY, 0, height, -height/1.5, height/1.5);

        // Update and draw each shape
        for (let i = 0; i < shapes.length; i++) {
            let shape = shapes[i];
            // Z-axis oscillation
            shape.z = shape.baseZ + sin(frameCount * zFrequency + shape.offset) * zAmplitude;
            shape.z = constrain(shape.z, -1000, approachDistance); // Keep shapes within view

            // Mouse interaction: push shapes away
            let dx = shape.x - mx;
            let dy = shape.y - my;
            let distToMouse = sqrt(dx * dx + dy * dy);
            let interactionRadius = 180;
            if (distToMouse < interactionRadius) {
                let force = map(distToMouse, 0, interactionRadius, 18 * mouseForceMultiplier, 0);
                shape.x += (dx / distToMouse) * force;
                shape.y += (dy / distToMouse) * force;
            } else { // Spring back to initial position
                let returnDx = shape.initX - shape.x;
                let returnDy = shape.initY - shape.y;
                shape.x += returnDx * springinessFactor;
                shape.y += returnDy * springinessFactor;
            }

            push(); // Isolate transformations for each shape
            translate(shape.x, shape.y, shape.z);
            rotateX(frameCount * shape.rotSpeedX);
            rotateY(frameCount * shape.rotSpeedY);
            rotateZ(frameCount * shape.rotSpeedZ);
            // Draw the shape based on its type
            switch (shape.shapeType) {
                case 'box': box(shape.size); break;
                case 'sphere': sphere(shape.size * 0.7); break;
                case 'torus': torus(shape.size * 0.5, shape.size * 0.2); break;
                case 'cone': cone(shape.size * 0.6, shape.size * 1.1); break;
                default: box(shape.size); // Fallback
            }
            pop(); // Restore transformation matrix
        }
    }

    // --- Shape Initialization & Management ---
    function getRandomShapeType() {
        let rand = random(); // p5.js random()
        let cumulativeProbability = 0;
        for (let i = 0; i < SHAPE_TYPES.length; i++) {
            cumulativeProbability += shapeProbabilities[i];
            if (rand < cumulativeProbability) {
                return SHAPE_TYPES[i];
            }
        }
        return SHAPE_TYPES[SHAPE_TYPES.length - 1]; // Fallback
    }

    function initializeShapes() {
        shapes = []; // Clear existing shapes
        for (let i = 0; i < numShapes; i++) {
            let initX = random(-150, 150); // p5.js random()
            let initY = random(-150, 150); // p5.js random()
            shapes.push({
                x: initX, y: initY, initX: initX, initY: initY,
                baseZ: random(-900, -250), // p5.js random()
                offset: random(TWO_PI), // p5.js random()
                rotSpeedX: random(baseRotSpeedRange[0], baseRotSpeedRange[1]) * (random() < 0.5 ? 1 : -1), // p5.js random()
                rotSpeedY: random(baseRotSpeedRange[0], baseRotSpeedRange[1]) * (random() < 0.5 ? 1 : -1), // p5.js random()
                rotSpeedZ: random(baseRotSpeedRange[0], baseRotSpeedRange[1]) * (random() < 0.5 ? 1 : -1), // p5.js random()
                shapeType: getRandomShapeType(),
                size: random(50, 110) // p5.js random()
            });
        }
    }

    // --- Starfield Logic ---
    function initializeStarfield() {
        starfieldParticles = [];
        for (let i = 0; i < NUM_STARS; i++) {
            starfieldParticles.push({
                x: random(-width * 2.5, width * 2.5), // p5.js random()
                y: random(-height * 2.5, height * 2.5), // p5.js random()
                z: random(-2500, -800), // p5.js random()
                size: random(1, 3.5), // p5.js random()
                baseBrightness: random(100, 200), // p5.js random()
                twinkleSpeed: random(0.05, 0.2) // p5.js random()
            });
        }
    }

    function drawStarfield() {
        push(); // Isolate starfield transformations
        noStroke(); // Stars are filled, no outline
        let parallaxX = map(mouseX, 0, width, -50, 50); // Parallax effect based on mouse X
        let parallaxY = map(mouseY, 0, height, -30, 30); // Parallax effect based on mouse Y

        for (let star of starfieldParticles) {
            push();
            translate(star.x + starDriftX + parallaxX * (star.z / -2500),
                      star.y + starDriftY + parallaxY * (star.z / -2500),
                      star.z);
            let twinkle = sin(frameCount * star.twinkleSpeed) * 50 + 25; // Twinkle effect
            let finalBrightness = constrain(star.baseBrightness + twinkle, 50, 255);
            // Lerp color from background to accent color based on brightness
            let starR = lerp(currentBgColor[0], currentAccentColor[0], finalBrightness / 255);
            let starG = lerp(currentBgColor[1], currentAccentColor[1], finalBrightness / 255);
            let starB = lerp(currentBgColor[2], currentAccentColor[2], finalBrightness / 255);
            fill(starR, starG, starB, finalBrightness * 0.8); // Apply color and transparency
            sphere(star.size); // Draw star as a small sphere
            pop();
        }
        pop(); // Restore transformations
    }

    // --- UI Control Functions ---
    function setShapeCount(count) {
        numShapes = max(1, int(count));
        initializeShapes();
        document.getElementById('shapeCountValue').textContent = numShapes;
    }
    function setLineWeightRange(minVal, maxVal) {
        minWeight = max(0.001, parseFloat(minVal));
        maxWeight = max(minWeight + 0.001, parseFloat(maxVal));
        document.getElementById('minLineWeightValue').textContent = minWeight.toFixed(3);
        document.getElementById('maxLineWeightValue').textContent = maxWeight.toFixed(3);
    }
    function setApproachDistance(distance) {
        approachDistance = parseFloat(distance);
        document.getElementById('approachDistanceValue').textContent = approachDistance;
    }
    function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        initializeStarfield(); // Re-initialize starfield for new dimensions
    }

    // --- UI Styling & Dynamic Theming ---
    function updateUICssVariables() {
        const root = document.documentElement;
        // Derive UI colors from the current p5.js stroke color and background color
        const uiPrimaryR = Math.min(255, currentStrokeColor[0] + 20);
        const uiPrimaryG = Math.min(255, currentStrokeColor[1] + 20);
        const uiPrimaryB = Math.min(255, currentStrokeColor[2] + 20);
        root.style.setProperty('--ui-primary-bg', `rgba(${uiPrimaryR}, ${uiPrimaryG}, ${uiPrimaryB}, 0.15)`);
        root.style.setProperty('--ui-primary-text', `rgb(${Math.min(255, uiPrimaryR + 80)}, ${Math.min(255, uiPrimaryG + 80)}, ${Math.min(255, uiPrimaryB + 80)})`);
        root.style.setProperty('--ui-primary-border', `rgb(${uiPrimaryR}, ${uiPrimaryG}, ${uiPrimaryB})`);
        root.style.setProperty('--ui-primary-hover-bg', `rgb(${uiPrimaryR}, ${uiPrimaryG}, ${uiPrimaryB})`);
        root.style.setProperty('--ui-primary-hover-text', `#FFFFFF`);

        const uiAccentR = currentAccentColor[0];
        const uiAccentG = currentAccentColor[1];
        const uiAccentB = currentAccentColor[2];
        root.style.setProperty('--ui-accent-text', `rgb(${Math.min(255, uiAccentR)}, ${Math.min(255, uiAccentG)}, ${Math.min(255, uiAccentB)})`);
        root.style.setProperty('--ui-value-display-text', `rgb(${Math.min(255, uiAccentR + 20)}, ${Math.min(255, uiAccentG + 20)}, ${Math.min(255, uiAccentB + 20)})`);
        root.style.setProperty('--ui-label-text', `rgb(${Math.max(0, uiAccentR - 40)}, ${Math.max(0, uiAccentG - 40)}, ${Math.max(0, uiAccentB - 40)})`); // Ensure labels are readable
        root.style.setProperty('--ui-slider-track-bg', `rgba(${uiPrimaryR}, ${uiPrimaryG}, ${uiPrimaryB}, 0.3)`);
        root.style.setProperty('--ui-slider-thumb-bg', `rgb(${uiPrimaryR}, ${uiPrimaryG}, ${uiPrimaryB})`);

        const panelBgR = Math.max(0, currentBgColor[0] - 5); // Slightly darker than canvas bg
        const panelBgG = Math.max(0, currentBgColor[1] - 5);
        const panelBgB = Math.max(0, currentBgColor[2] + 0);
        root.style.setProperty('--ui-panel-bg', `rgba(${panelBgR}, ${panelBgG}, ${panelBgB}, 0.94)`);

        const panelBorderR = Math.max(0, currentBgColor[0] + 30); // Border color derived from bg
        const panelBorderG = Math.max(0, currentBgColor[1] + 30);
        const panelBorderB = Math.max(0, currentBgColor[2] + 40);
        root.style.setProperty('--ui-panel-border', `rgba(${panelBorderR}, ${panelBorderG}, ${panelBorderB}, 0.7)`);
    }

    // --- In-Page JavaScript Randomization Functions ---
    function randomizeColors() {
        // Generate random colors for background, stroke, and accent
        currentBgColor = [random(0, 50), random(0, 50), random(0, 70)]; // Darker tones for bg
        currentStrokeColor = [random(50, 200), random(50, 200), random(100, 255), random(150, 220)]; // Brighter, varied stroke
        currentAccentColor = [random(150, 255), random(150, 255), random(200, 255)]; // Lighter accents
        updateUICssVariables(); // Apply new colors to UI elements
        console.log("Colors randomized:", { bg: currentBgColor, stroke: currentStrokeColor, accent: currentAccentColor });
    }

    function randomizeShapeTheme() {
        // Randomly distribute probabilities among shape types
        let newProbs = [];
        let sum = 0;
        for (let i = 0; i < SHAPE_TYPES.length; i++) {
            let prob = random(0.1, 1.0); // p5.js random()
            newProbs.push(prob);
            sum += prob;
        }
        // Normalize probabilities so they sum to 1
        if (sum > 0) {
            shapeProbabilities = newProbs.map(p => p / sum);
        } else { // Fallback to equal probability if sum is 0 (unlikely)
            shapeProbabilities = Array(SHAPE_TYPES.length).fill(1 / SHAPE_TYPES.length);
        }
        initializeShapes(); // Re-initialize shapes with new theme
        console.log("Shape theme randomized. Probabilities:", shapeProbabilities);
    }

    function randomizeMotionStyle() {
        // Randomize motion parameters within sensible ranges
        baseRotSpeedRange = [-0.01 * random(0.5, 3), 0.01 * random(0.5, 3)]; // p5.js random()
        zAmplitude = 500 * random(0.3, 2.0); // p5.js random()
        zFrequency = 0.15 * random(0.3, 2.0); // p5.js random()
        mouseForceMultiplier = 1.0 * random(0.5, 2.5); // p5.js random()
        springinessFactor = 0.03 * random(0.5, 2.0); // p5.js random()
        initializeShapes(); // Re-initialize shapes to apply new motion
        console.log("Motion style randomized:", { rot: baseRotSpeedRange, zAmp: zAmplitude, zFreq: zFrequency, mouseF: mouseForceMultiplier, spring: springinessFactor });
    }

    // --- Custom Modal Alert Functionality ---
    function showCustomAlert(message) {
        const modal = document.getElementById('customModal');
        const messageElement = document.getElementById('customModalMessage');
        if (modal && messageElement) {
            messageElement.textContent = message;
            modal.style.display = 'flex'; // Use flex to center content
        } else {
            console.warn("Custom modal elements not found. Falling back to console for message:", message);
        }
    }

    // --- Page Controls Initialization ---
    function initializePageControls() {
        const shapeCountSlider = document.getElementById('shapeCount');
        const approachDistanceSlider = document.getElementById('approachDistance');
        const minLineWeightSlider = document.getElementById('minLineWeight');
        const maxLineWeightSlider = document.getElementById('maxLineWeight');
        const resetButton = document.getElementById('resetDefaults');

        // New buttons for JS randomization
        const randomizeColorBtn = document.getElementById('randomizeColorButton');
        const randomizeShapeBtn = document.getElementById('randomizeShapeButton');
        const randomizeMotionBtn = document.getElementById('randomizeMotionButton');

        const controlsToggleButton = document.getElementById('controlsToggleButton');
        const controlsOverlay = document.getElementById('controlsOverlay');

        const siteMenuTrigger = document.getElementById('siteMenuTrigger');
        const siteNavMenu = document.getElementById('siteNavMenu');

        // Custom Modal Close Button
        const customModalCloseButton = document.getElementById('customModalClose');
        if (customModalCloseButton) {
            customModalCloseButton.addEventListener('click', () => {
                const modal = document.getElementById('customModal');
                if (modal) modal.style.display = 'none';
            });
        }


        if (controlsToggleButton) controlsToggleButton.innerHTML = gearIconSVG; // Set initial icon

        // Default settings for reset
        const defaultSettings = {
            shapes: 1000, approach: 1, minLine: 0.02, maxLine: 0.1,
            bgColor: [5, 5, 10], strokeColor: [72, 61, 139, 180], accentColor: [200, 200, 255],
            shapeProbs: [0.25, 0.25, 0.25, 0.25],
            rotSpeedRange: [-0.02, 0.02], zAmp: 500, zFreq: 0.15, mouseForce: 1.0, springiness: 0.03
        };

        // Initialize slider display values
        document.getElementById('shapeCountValue').textContent = numShapes;
        document.getElementById('approachDistanceValue').textContent = approachDistance;
        document.getElementById('minLineWeightValue').textContent = minWeight.toFixed(3);
        document.getElementById('maxLineWeightValue').textContent = maxWeight.toFixed(3);

        // Initialize slider positions
        shapeCountSlider.value = numShapes;
        approachDistanceSlider.value = approachDistance;
        minLineWeightSlider.value = minWeight;
        maxLineWeightSlider.value = maxWeight;

        // Event listeners for sliders
        if (shapeCountSlider) shapeCountSlider.addEventListener('input', (e) => setShapeCount(e.target.value));
        if (approachDistanceSlider) approachDistanceSlider.addEventListener('input', (e) => setApproachDistance(e.target.value));
        if (minLineWeightSlider && maxLineWeightSlider) {
            minLineWeightSlider.addEventListener('input', (e) => setLineWeightRange(e.target.value, maxLineWeightSlider.value));
            maxLineWeightSlider.addEventListener('input', (e) => setLineWeightRange(minLineWeightSlider.value, e.target.value));
        }
        // Event listener for reset button
        if (resetButton) {
            resetButton.addEventListener('click', () => {
                numShapes = defaultSettings.shapes;
                setShapeCount(numShapes);
                shapeCountSlider.value = numShapes;
                approachDistance = defaultSettings.approach;
                setApproachDistance(approachDistance);
                approachDistanceSlider.value = approachDistance;
                minWeight = defaultSettings.minLine;
                maxWeight = defaultSettings.maxLine;
                setLineWeightRange(minWeight, maxWeight);
                minLineWeightSlider.value = minWeight;
                maxLineWeightSlider.value = maxWeight;
                currentBgColor = [...defaultSettings.bgColor];
                currentStrokeColor = [...defaultSettings.strokeColor];
                currentAccentColor = [...defaultSettings.accentColor];
                updateUICssVariables();
                shapeProbabilities = [...defaultSettings.shapeProbs];
                baseRotSpeedRange = [...defaultSettings.rotSpeedRange];
                zAmplitude = defaultSettings.zAmp;
                zFrequency = defaultSettings.zFreq;
                mouseForceMultiplier = defaultSettings.mouseForce;
                springinessFactor = defaultSettings.springiness;
                initializeShapes();
                console.log("Settings reset to defaults.");
            });
        }

        // Event listeners for new randomization buttons
        if (randomizeColorBtn) randomizeColorBtn.addEventListener('click', randomizeColors);
        if (randomizeShapeBtn) randomizeShapeBtn.addEventListener('click', randomizeShapeTheme);
        if (randomizeMotionBtn) randomizeMotionBtn.addEventListener('click', randomizeMotionStyle);


        // Event listener for controls toggle button
        if (controlsToggleButton && controlsOverlay) {
            controlsToggleButton.addEventListener('click', () => {
                const isHidden = controlsOverlay.classList.toggle('hidden');
                controlsToggleButton.setAttribute('aria-expanded', String(!isHidden));
                controlsToggleButton.innerHTML = isHidden ? gearIconSVG : closeIconSVG; // Toggle icon
                controlsToggleButton.classList.toggle('panel-open', !isHidden);
                if (!isHidden) { // If panel is opened
                    const firstButton = controlsOverlay.querySelector('button, input[type="range"]');
                    if (firstButton) firstButton.focus();
                    else controlsOverlay.focus(); // Fallback focus to panel itself
                } else { // If panel is closed
                    controlsToggleButton.focus();
                }
            });
        }

        // Event listener for site menu toggle
        if (siteMenuTrigger && siteNavMenu) {
            siteMenuTrigger.addEventListener('click', (e) => {
                e.preventDefault();
                const isVisible = siteNavMenu.classList.toggle('visible');
                siteMenuTrigger.setAttribute('aria-expanded', isVisible);
            });
        }
        // Close site menu if clicking outside
        document.addEventListener('click', function(event) {
            if (siteNavMenu && siteMenuTrigger) {
                const isClickInsideMenu = siteNavMenu.contains(event.target);
                const isClickOnTrigger = siteMenuTrigger.contains(event.target);
                if (!isClickInsideMenu && !isClickOnTrigger && siteNavMenu.classList.contains('visible')) {
                    siteNavMenu.classList.remove('visible');
                    siteMenuTrigger.setAttribute('aria-expanded', 'false');
                }
            }
        });
    }
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1CQ4D3VQ3L');
    </script>
</body>
</html>
